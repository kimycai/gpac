name: Build MP4Box & Release
# 触发条件：仅在打TAG时触发（规范版本发布，如v1.0.0、v2.1.1）
on:
  push:
    tags:
      - 'v*' # 匹配所有v开头的标签，如v0.1、v1.2.3、v2026.01.30

jobs:
  build-and-release:
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：拉取仓库代码（含TAG对应版本）
      - name: Checkout source code
        uses: actions/checkout@v4

      # 步骤2：安装编译依赖（git已预装，按需保留zlib）
      - name: Install build dependencies
        run: |
          sudo apt update -y
          sudo apt install -y gcc make zlib1g-dev

      # 步骤3：编译MP4Box（沿用静态编译+禁用zlib，按需修改）
      - name: Configure and build MP4Box
        run: |
          ./configure --static-mp4box --use-zlib=no
          make -j4 # 多线程加速编译

      # 步骤4：重命名产物（可选，增加架构/系统标识，方便区分）
      - name: Rename MP4Box binary
        run: mv bin/gcc/MP4Box bin/gcc/mp4box-linux-x64-static
        # 重命名后：mp4box-linux-x64-static，明确是Linux/x64/静态编译版本

      # 步骤5：自动创建Release并上传产物（核心步骤）
      - name: Create Release and upload artifact
        uses: softprops/action-gh-release@v2 # 官方推荐的Release Action
        with:
          # 上传的产物路径（对应重命名后的文件，可写多个）
          files: bin/gcc/mp4box-linux-x64-static
          # 可选：自动生成Release说明（含提交记录）
          generate_release_notes: true
        # 必须：传入GitHub令牌，用于授权创建Release/上传文件（Actions自动提供）
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
